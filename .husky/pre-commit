#!/bin/sh

# Fail fast on any error
set -e

# Check if we're in CI environment - skip hooks in CI
if [ "$CI" = "true" ] || [ "$HUSKY" = "0" ]; then
  echo "â„¹ï¸  CI environment detected or HUSKY=0 set, skipping pre-commit checks."
  exit 0
fi

echo "ğŸ” Running pre-commit checks..."

# Function to handle errors with better reporting
handle_error() {
  echo "âŒ Pre-commit check failed: $1"
  echo "ğŸ’¡ To skip pre-commit hooks temporarily, use: HUSKY_SKIP_HOOKS=1 git commit"
  echo "ğŸ’¡ To disable husky entirely, use: HUSKY=0 git commit"
  exit 1
}

# Run linting on all files (no stashing)
echo "ğŸ“ Running linting with auto-fix..."
npm run lint:fix || handle_error "ESLint failed"

# Run prettier on all files
echo "ğŸ¨ Running formatter..."
npm run format || handle_error "Prettier failed"

# Run typecheck
echo "ğŸ”§ Running typecheck..."
npm run typecheck || handle_error "TypeScript type checking failed"

# Run fast tests (excludes slow/1M record tests)
echo "ğŸ§ª Running tests (excluding slow tests)..."
npm run test:fast || handle_error "Fast tests failed"

# Skip debug tests for now - some have issues
# echo "ğŸ” Running debug tests..."
# npm run test:debug || handle_error "Debug tests failed"

echo "âœ… All pre-commit checks passed!"
